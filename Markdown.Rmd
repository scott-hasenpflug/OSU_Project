---
title: "OSU Salary Analysis"
author: "Scott Hasenpflug"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Exploratory Analysis
```{r preparation, include = FALSE}
library(tidyverse)
library(pdftools)
library(rebus)
library(lubridate)
library(tidytext)
library(skimr)
library(scales)
library(knitr)

raw_import <- pdf_text("unclassified_output.pdf")

pages_listed <- raw_import %>%
        str_split("---------------------------------------------------------------------------------")

for (i in 1:1050) {
        pages_listed[[i]] <- pages_listed[[i]][-1]
}

pages_unlisted <- unlist(pages_listed)

short <- str_length(pages_unlisted) < 600
long <- str_length(pages_unlisted) >= 600

single <- pages_unlisted[short] 
multiple <- pages_unlisted[long] 

one_job <- list(single)
multiple_jobs <- list(multiple)

        Variable_Names <- c("name", "first_hired", "home_orgn", "adj_service_date", "job_orgn", 
        "job_type", "job_title", "posn_suff", "rank_name", "rank_effective_date", "appt_begin_date",
        "appt_percent", "appt_end_date", "annual_salary_rate", "months_length")
        x <- c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o")

        df <- NULL
        df <- rbind(df, x)
        colnames(df) <- Variable_Names

for (i in 1:length(one_job[[1]])) {
        name <- str_match(one_job[[1]][i], pattern = "Name: " %R% capture(lazy(zero_or_more(char_class(WRD, NOT_WRD)))) %R% SPC %R% SPC)[,-1]
        first_hired <- str_match(one_job[[1]][i], pattern = "First Hired: " %R% capture(one_or_more(DGT) %R% "\\-" %R% one_or_more(WRD) %R% "\\-" %R% one_or_more(DGT)))[, -1]
        home_orgn <- str_match(one_job[[1]][i], pattern = "Home Orgn: " %R% capture(lazy(zero_or_more(char_class(WRD, NOT_WRD)))) %R% SPC %R% or(SPC, "Adj"))[,-1]
        adj_service_date <- str_match(one_job[[1]][i], pattern = "Adj Service Date: " %R% capture(one_or_more(DGT) %R% "\\-" %R% one_or_more(WRD) %R% "\\-" %R% one_or_more(DGT)))[, -1]
        job_orgn <- str_match(one_job[[1]][i], pattern = "Job Orgn: " %R% capture(lazy(zero_or_more(char_class(WRD, NOT_WRD)))) %R% SPC %R% SPC)[,-1]
        job_type <- str_match(one_job[[1]][i], pattern = "Job Type: " %R% capture(one_or_more(WRD)))[, -1]
        job_title <- str_trim(str_match(one_job[[1]][i], pattern = "Job Title: " %R% capture(one_or_more(char_class(WRD, SPACE, PUNCT))) %R% "Posn")[, -1])
        posn_suff <- str_match(one_job[[1]][i], pattern = "Posn-Suff: " %R% capture(lazy(zero_or_more(char_class(WRD, NOT_WRD)))) %R% SPC %R% SPC)[, -1]
        rank_name <- str_trim(str_match(one_job[[1]][i], pattern = "Rank: " %R% capture(one_or_more(char_class(WRD, SPACE, PUNCT))) %R% "Rank E")[, -1])
        rank_effective_date <- str_match(one_job[[1]][i], pattern = "Rank Effective Date: " %R% capture(one_or_more(DGT) %R% "\\-" %R% one_or_more(WRD) %R% "\\-" %R% one_or_more(DGT)))[, -1]
        appt_begin_date <- str_match(one_job[[1]][i], pattern = "Appt Begin Date: " %R% capture(one_or_more(DGT) %R% "\\-" %R% one_or_more(WRD) %R% "\\-" %R% one_or_more(DGT)))[, -1]
        appt_percent <- str_match(one_job[[1]][i], pattern = "Appt Percent:" %R% zero_or_more(SPC) %R% capture(one_or_more(DGT)))[, -1]
        appt_end_date <- str_match(one_job[[1]][i], pattern = "Appt End Date: " %R% capture(one_or_more(DGT) %R% "\\-" %R% one_or_more(WRD) %R% "\\-" %R% one_or_more(DGT)))[, -1]
        annual_salary_rate <- str_match(one_job[[1]][i], pattern = "Annual Salary Rate:" %R% one_or_more(SPC) %R% capture(one_or_more(DGT) %R% DOT %R% one_or_more(DGT)))[, -1]
        months_length <- str_match(one_job[[1]][i], pattern = capture(one_or_more(DGT)) %R% SPC %R% "mo")[, -1]
        
        x <- c(name, first_hired, home_orgn, adj_service_date, job_orgn, 
               job_type, job_title, posn_suff, rank_name, rank_effective_date, appt_begin_date,
               appt_percent, appt_end_date, annual_salary_rate, months_length)
        
        df <- rbind(df, x)
} 

df <- as_tibble(df) %>%
        .[-1,]

df$annual_salary_rate <- as.numeric(as.character(df$annual_salary_rate))

df <- df %>%
        mutate(first_hired = dmy(first_hired), 
               adj_service_date = dmy(adj_service_date),
               rank_effective_date = dmy(rank_effective_date),
               appt_begin_date = dmy(appt_begin_date))

df <- df %>%
        mutate(home_org_code = str_extract(home_orgn, pattern = START %R% WRD %R% WRD %R% WRD))

df <- df %>%
        mutate(mo_label = recode_factor(months_length, `9` = "short", `12` = "long"))
```

```{r max pay, echo = FALSE}
max_pay_employee <- df %>% filter(annual_salary_rate == max(df$annual_salary_rate, na.rm = TRUE)) %>%
        pull(name)

max_pay <- df %>% filter(annual_salary_rate == max(df$annual_salary_rate, na.rm = TRUE)) %>%
        pull(annual_salary_rate) %>%
        dollar()

max_pay_title <- df %>% filter(annual_salary_rate == max(df$annual_salary_rate, na.rm = TRUE)) %>%
        pull(job_title)
```
`r max_pay_employee` is the **highest** paid OSU employee at `r max_pay` per year in the role of `r max_pay_title`.

### Double check the following names to ensure they are separate individuals and not employees with two jobs: `r kable(df$name[duplicated(df$name)], col.names = "Name")`

## The most common titles are:
```{r  top titles, echo = FALSE, out.width="75%", }
df %>%
        count(job_title, sort = TRUE) %>%
        head(5) %>%
        rename(Title = job_title, Count = n) %>%
        kable()
```
## Titles held by at least 30 employees:

```{r titles graph, echo = FALSE, out.width="75%", fig.align='left'}
common_titles <- df %>%
        count(job_title, sort = TRUE) %>%
        filter(n > 30)

ggplot(common_titles, aes(n, reorder(job_title, n))) +
        geom_col() +
        labs(title = "Most Common Titles", 
             y = "", 
             x = "") +
        theme_minimal()
```

```{r loaners, include = FALSE}
not_loaned <- sum(df$home_orgn == df$job_orgn)         
loaned <- sum(df$home_orgn != df$job_orgn) 
```
### `r percent(loaned/(loaned + not_loaned))` of employees are currently  working outside of their home organization

## Organizations with the highest salaries:
```{r highest_salary_org, echo = FALSE, warning=FALSE}
df %>%
        group_by(home_orgn) %>%
        summarize(Min = min(annual_salary_rate, na.rm = TRUE),
                  Mean = mean(annual_salary_rate, na.rm = TRUE),
                  Median = median(annual_salary_rate, na.rm = TRUE),
                  Max = max(annual_salary_rate, na.rm = TRUE),
                  Employees = n()) %>%
        ungroup() %>%
        arrange(desc(Mean)) %>%
        mutate(Min = dollar(round(Min)), Mean = dollar(round(Mean)), 
               Median = dollar(round(Median)), Max = dollar(round(Max))) %>%
        head() %>%
        rename(Organization = home_orgn) %>%
        kable()
```

```{r rank and title analysis, echo = FALSE}
senior_rank <- str_detect(df$rank_name, pattern = "Senior")
assistant_rank <- str_detect(df$rank_name, pattern = "Assistant")
professor_rank <- str_detect(df$rank_name, pattern = "Professor")
associate_rank <- str_detect(df$rank_name, pattern = "Associate")
instructor_rank <- str_detect(df$rank_name, pattern = "Instructor")

director_title <- str_detect(df$job_title, pattern = or("Director", "Dir-", "Dir."))
manager_title <- str_detect(df$job_title, pattern = or("Manager", "Mgr"))
president_title <- str_detect(df$job_title, pattern = or("President", "Pres.", "Pres-"))

prof <- dollar(median(df$annual_salary_rate[professor_rank], na.rm = TRUE))
inst <- dollar(median(df$annual_salary_rate[instructor_rank], na.rm = TRUE))
```
### The median salary for a professor is `r prof`, `r percent((median(df$annual_salary_rate[professor_rank], na.rm = TRUE)/median(df$annual_salary_rate[instructor_rank], na.rm = TRUE))-1)` higher than the median salary for instructors (`r inst`)

## President title salary summary:
```{r presidents, echo = FALSE}
df %>%
        mutate(Prez = president_title) %>%
        filter(Prez == TRUE) %>%
        group_by(home_orgn) %>%
        summarize(Presidents = n(), Salary = mean(annual_salary_rate)) %>%
        ungroup() %>%
        arrange(desc(Salary)) %>%
        mutate(Salary = dollar(Salary)) %>%
        rename(Organization = home_orgn) %>%
        rename("Average Salary" = Salary) %>%
        kable()
```
## How "Directors" are paid across OSU:
```{r , echo = FALSE, out.width="75%"}
df %>%
        mutate(Direc = director_title) %>%
        filter(Direc == TRUE) %>%
        group_by(home_orgn) %>%
        summarize(Directors = n(), Mean_Salary = mean(annual_salary_rate)) %>%
        ungroup() %>%
        arrange(desc(Mean_Salary)) %>% # how do I print this?
        ggplot(aes(Mean_Salary)) +
        geom_histogram(binwidth = 7500) +
        theme_minimal() +
        labs(title = '"Director" Salary Distribution', x = "Mean Salary", y = "Count") 
```

```{r bin calculations, include = FALSE}
df <- df %>%
        mutate(appt_begin_date = replace(appt_begin_date, appt_begin_date == "0221-01-01", "2021-01-01")) 

# Fix adj_service_date typo
df <- df %>%
        mutate(adj_service_date = replace(adj_service_date, adj_service_date == "0200-05-04", "2020-05-04")) 

# Calculate tenure as # of years since first hired (rounded down) ***This is janky. 
# Figure it out better in lubridate***
df <- df %>%
        mutate(tenure = floor((as.numeric((today() - first_hired)/365))))

# Create labels for the bins
tenure_bin_labels <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40+")

# Create a column of the bin value based on tenure
df <- df %>%
        mutate(tenure_bin = factor(if_else(tenure < 5, "0-4", 
                                if_else(tenure < 10, "5-9",
                                if_else(tenure < 15, "10-14",
                                if_else(tenure < 20, "15-19",
                                if_else(tenure < 25, "20-24",
                                if_else(tenure < 30, "25-29", 
                                if_else(tenure < 35, "30-34",
                                if_else(tenure < 40, "35-39", "40+")))))))), levels = tenure_bin_labels))
```

# Tenure Distribution
```{r binning, echo = FALSE, out.width="85%"}
ggplot(df, aes(tenure_bin)) +
        geom_bar(fill = "#000000") +
        theme_minimal() +
        labs(title = "University", x = "Years of Service", y = "Count")
```

```{r top 2 binning, echo = FALSE}
df %>%
        filter(home_org_code %in% c("HHS", "CLA")) %>%
        ggplot(aes(tenure_bin, fill = home_org_code)) +
        geom_bar(position = "dodge") +
        scale_fill_manual("Organization", values = c("#D73F09", "#000000")) +
        labs(title = "Largest 2 Organizations", x = "Years of Service", y = "Count") +
        theme_minimal()
```
![Logo](osu_primary_logo.jpg)
